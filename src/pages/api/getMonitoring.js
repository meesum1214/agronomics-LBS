
// Example Response
// {
//   "Date": {
//       "0": "Sun, 08 Aug 2021 00:00:00 GMT",
//       "1": "Fri, 13 Aug 2021 00:00:00 GMT",
//   },
//   "Max": {
//       "0": "{'AOT': 265, 'ARVI': 0.7380898622713931, 'B1': 382, 'B11': 2010, 'B12': 1137, 'B2': 1023, 'B3': 1150, 'B4': 907, 'B5': 1169, 'B6': 3284, 'B7': 3835, 'B8': 4257, 'B8A': 3964, 'B9': 4279, 'EVI': 10.23391812865497, 'EVI_1': 10.23391812865497, 'GCI': 4.630769230769231, 'GNDVI': 0.6983758700696056, 'MSAVI': -640.6907975957345, 'MSK_CLDPRB': 1, 'MSK_SNWPRB': 0, 'NBR': 0.6420443587270974, 'NDSI': -0.19495974798739937, 'NDVI': 0.80696124413725, 'NDWI': -0.3958497504596795, 'OSAVI': 0.8069293733152973, 'QA10': 0, 'QA20': 0, 'QA60': 0, 'RECL': 8.360613810741688, 'SAVI': 1.210292484265087, 'SCL': 4, 'SIPI': 1.0288018433179724, 'TCI_B': 103, 'TCI_G': 117, 'TCI_R': 93, 'VARI': 0.43759177679882527, 'WVP': 2681}",
//       "1": "{'AOT': 244, 'ARVI': 0.7131940906775344, 'B1': 431, 'B11': 1983, 'B12': 1171, 'B2': 858, 'B3': 1100, 'B4': 846, 'B5': 1222, 'B6': 3047, 'B7': 3494, 'B8': 3675, 'B8A': 3798, 'B9': 3643, 'EVI': 3.45952023988006, 'EVI_1': 3.45952023988006, 'GCI': 4.523316062176166, 'GNDVI': 0.69340746624305, 'MSAVI': -653.6402489813254, 'MSK_CLDPRB': 0, 'MSK_SNWPRB': 0, 'NBR': 0.5872797986730726, 'NDSI': -0.2864093415504379, 'NDVI': 0.778642936596218, 'NDWI': -0.41983122362869196, 'OSAVI': 0.7786082932906211, 'QA10': 0, 'QA20': 0, 'QA60': 0, 'RECL': 7.035175879396984, 'SAVI': 1.1678020297511469, 'SCL': 4, 'SIPI': 1.0732984293193717, 'TCI_B': 89, 'TCI_G': 111, 'TCI_R': 86, 'VARI': 0.3493635077793494, 'WVP': 2801}",
//   },
//   "Mean": {
//       "0": "{'AOT': 264.30355932203383, 'ARVI': 0.668592529028894, 'B1': 313.2593220338983, 'B11': 1750.8352542372877, 'B12': 941.1930508474574, 'B2': 468.36593220338983, 'B3': 740.1249152542374, 'B4': 491.1447457627118, 'B5': 1034.2942372881357, 'B6': 2795.109661016949, 'B7': 3273.730508474575, 'B8': 3417.580677966101, 'B8A': 3380.1138983050832, 'B9': 3328.893728813558, 'EVI': 2.79237195579853, 'EVI_1': 2.79237195579853, 'GCI': 3.7005914165277836, 'GNDVI': 0.6414666810893667, 'MSAVI': -789.0884299585903, 'MSK_CLDPRB': 0.14881355932203388, 'MSK_SNWPRB': 0, 'NBR': 0.5667782963830554, 'NDSI': -0.40610220902029365, 'NDVI': 0.7465788795656613, 'NDWI': -0.6414666810893667, 'OSAVI': 0.7465480042418386, 'QA10': 0, 'QA20': 0, 'QA60': 0, 'RECL': 6.31940188958961, 'SAVI': 1.1197236041654752, 'SCL': 4, 'SIPI': 1.0063608210186636, 'TCI_B': 47.70610169491525, 'TCI_G': 75.73152542372878, 'TCI_R': 50.25288135593218, 'VARI': 0.33459866854556014, 'WVP': 2624.5993220338974}",
//       "1": "{'AOT': 243.3589830508474, 'ARVI': 0.640811995327993, 'B1': 393.58593220338975, 'B11': 1874.0032203389826, 'B12': 1034.4723728813558, 'B2': 438.12067796610165, 'B3': 715.3996610169492, 'B4': 529.9206779661017, 'B5': 1100.82406779661, 'B6': 2733.2223728813556, 'B7': 3238.1391525423733, 'B8': 3202.5011864406774, 'B8A': 3505.1315254237284, 'B9': 3528.558813559321, 'EVI': 2.182053615094096, 'EVI_1': 2.182053615094096, 'GCI': 3.5397890988964162, 'GNDVI': 0.6339681647598949, 'MSAVI': -762.8435566289579, 'MSK_CLDPRB': 0, 'MSK_SNWPRB': 0, 'NBR': 0.509635923782246, 'NDSI': -0.4493174842253436, 'NDVI': 0.7146544325612499, 'NDWI': -0.6339681647598949, 'OSAVI': 0.7146237189336435, 'QA10': 0, 'QA20': 0, 'QA60': 0, 'RECL': 5.248040567158309, 'SAVI': 1.0718376919202988, 'SCL': 4, 'SIPI': 1.0351238479920744, 'TCI_B': 45.046271186440684, 'TCI_G': 73.1752542372881, 'TCI_R': 54.41728813559321, 'VARI': 0.23316619840242048, 'WVP': 2679.771355932203}",
//   },
//   "Median": {
//       "0": "{'AOT': 264, 'ARVI': 0.6984365604329525, 'B1': 286, 'B11': 1743, 'B12': 928, 'B2': 433, 'B3': 721, 'B4': 490, 'B5': 1035, 'B6': 2799, 'B7': 3257, 'B8': 3484, 'B8A': 3311, 'B9': 3280, 'EVI': 2.5211201501877345, 'EVI_1': 2.5211201501877345, 'GCI': 3.8676258992805757, 'GNDVI': 0.6591466405100539, 'MSAVI': -797.3578696634318, 'MSK_CLDPRB': 0, 'MSK_SNWPRB': 0, 'NBR': 0.5852214737701572, 'NDSI': -0.42306266221727845, 'NDVI': 0.7731305449936628, 'NDWI': -0.6591466405100539, 'OSAVI': 0.773091351515766, 'QA10': 0, 'QA20': 0, 'QA60': 0, 'RECL': 6.815642458100559, 'SAVI': 1.1595121178520513, 'SCL': 4, 'SIPI': 1.0080761465243726, 'TCI_B': 44, 'TCI_G': 73, 'TCI_R': 49, 'VARI': 0.3475682087781732, 'WVP': 2638}",
//       "1": "{'AOT': 243, 'ARVI': 0.6474802371541502, 'B1': 370, 'B11': 1844, 'B12': 1051, 'B2': 417, 'B3': 698, 'B4': 518, 'B5': 1127, 'B6': 2704, 'B7': 3199, 'B8': 3198, 'B8A': 3427, 'B9': 3622, 'EVI': 2.161912104857363, 'EVI_1': 2.161912104857363, 'GCI': 3.5, 'GNDVI': 0.6363636363636364, 'MSAVI': -762.9204818163346, 'MSK_CLDPRB': 0, 'MSK_SNWPRB': 0, 'NBR': 0.5228149829738933, 'NDSI': -0.45235223160434257, 'NDVI': 0.7225462845549074, 'NDWI': -0.6363636363636364, 'OSAVI': 0.7225169660881121, 'QA10': 0, 'QA20': 0, 'QA60': 0, 'RECL': 5.208409506398538, 'SAVI': 1.0836820083682008, 'SCL': 4, 'SIPI': 1.0338801711840229, 'TCI_B': 43, 'TCI_G': 72, 'TCI_R': 54, 'VARI': 0.24838292367399742, 'WVP': 2646}",
//   },
//   "Min": {
//       "0": "{'AOT': 263, 'ARVI': 0.38151297144102897, 'B1': 259, 'B11': 1340, 'B12': 640, 'B2': 338, 'B3': 531, 'B4': 348, 'B5': 763, 'B6': 2193, 'B7': 2614, 'B8': 2657, 'B8A': 2750, 'B9': 2528, 'EVI': 2.190259904113046, 'EVI_1': 2.190259904113046, 'GCI': 1.3104347826086955, 'GNDVI': 0.3958497504596795, 'MSAVI': -955.7509240155221, 'MSK_CLDPRB': 0, 'MSK_SNWPRB': 0, 'NBR': 0.43854899837574446, 'NDSI': -0.47283049472830496, 'NDVI': 0.4910213243546577, 'NDWI': -0.6983758700696056, 'OSAVI': 0.49099928173819357, 'QA10': 0, 'QA20': 0, 'QA60': 0, 'RECL': 1.9294377067254684, 'SAVI': 0.7364286716229484, 'SCL': 4, 'SIPI': 0.9337142857142857, 'TCI_B': 32, 'TCI_G': 54, 'TCI_R': 36, 'VARI': 0.16732673267326734, 'WVP': 2571}",
//       "1": "{'AOT': 242, 'ARVI': 0.41992720655141036, 'B1': 368, 'B11': 1767, 'B12': 902, 'B2': 330, 'B3': 579, 'B4': 398, 'B5': 944, 'B6': 2421, 'B7': 2880, 'B8': 2692, 'B8A': 3079, 'B9': 3240, 'EVI': 1.7488378644879559, 'EVI_1': 1.7488378644879559, 'GCI': 1.4472727272727273, 'GNDVI': 0.41983122362869196, 'MSAVI': -848.699928902857, 'MSK_CLDPRB': 0, 'MSK_SNWPRB': 0, 'NBR': 0.3937354387781517, 'NDSI': -0.5336426914153132, 'NDVI': 0.5217637083097796, 'NDWI': -0.69340746624305, 'OSAVI': 0.5217401135053248, 'QA10': 0, 'QA20': 0, 'QA60': 0, 'RECL': 2.182033096926714, 'SAVI': 0.7825349724459516, 'SCL': 4, 'SIPI': 0.9934994582881906, 'TCI_B': 34, 'TCI_G': 59, 'TCI_R': 40, 'VARI': 0.10844748858447488, 'WVP': 2618}",
//   },
//   "Mode": {
//       "0": "{'AOT': 264, 'ARVI': 0.552490063128361, 'B1': 286, 'B11': 1577, 'B12': 869, 'B2': 420, 'B3': 678, 'B4': 384, 'B5': 967, 'B6': 2508, 'B7': 2936, 'B8': 2934, 'B8A': 3013, 'B9': 3280, 'EVI': 2.190259904113046, 'EVI_1': 2.190259904113046, 'GCI': 2.6369119420989144, 'GNDVI': 0.568678459937565, 'MSAVI': -955.7509240155221, 'MSK_CLDPRB': 0, 'MSK_SNWPRB': 0, 'NBR': 0.48815399802566634, 'NDSI': -0.4620952380952381, 'NDVI': 0.6443959640032725, 'NDWI': -0.6799526440410418, 'OSAVI': 0.6443678486894491, 'QA10': 0, 'QA20': 0, 'QA60': 0, 'RECL': 3.624233128834356, 'SAVI': 0.9664621676891616, 'SCL': 4, 'SIPI': 0.992020427705075, 'TCI_B': 44, 'TCI_G': 72, 'TCI_R': 51, 'VARI': 0.20321469575200918, 'WVP': 2656}",
//       "1": "{'AOT': 243, 'ARVI': 0.5712184358911498, 'B1': 370, 'B11': 1938, 'B12': 1051, 'B2': 413, 'B3': 694, 'B4': 455, 'B5': 1127, 'B6': 3047, 'B7': 3494, 'B8': 2946, 'B8A': 3798, 'B9': 3622, 'EVI': 1.7488378644879559, 'EVI_1': 1.7488378644879559, 'GCI': 3.1013888888888888, 'GNDVI': 0.6079499047100463, 'MSAVI': -848.699928902857, 'MSK_CLDPRB': 0, 'MSK_SNWPRB': 0, 'NBR': 0.431139179013845, 'NDSI': -0.4813027744270205, 'NDVI': 0.651565995525727, 'NDWI': -0.6696542893725992, 'OSAVI': 0.6515368439890833, 'QA10': 0, 'QA20': 0, 'QA60': 0, 'RECL': 3.739967897271268, 'SAVI': 0.9772123584509995, 'SCL': 4, 'SIPI': 1.0213299874529485, 'TCI_B': 42, 'TCI_G': 72, 'TCI_R': 54, 'VARI': 0.10844748858447488, 'WVP': 2646}",
//   },
//   "StdDev": {
//       "0": "{'AOT': 0.6055820990061882, 'ARVI': 0.09122719841340331, 'B1': 47.03833452551044, 'B11': 178.78153019468218, 'B12': 117.23319465137114, 'B2': 159.72882265386355, 'B3': 127.69093713075662, 'B4': 139.43455891306743, 'B5': 106.77864317803166, 'B6': 322.5011246884733, 'B7': 377.554828327217, 'B8': 438.7840347044674, 'B8A': 380.0985744198363, 'B9': 603.2545287563356, 'EVI': 1.5853733796289273, 'EVI_1': 1.5853733796289273, 'GCI': 0.8141905345312797, 'GNDVI': 0.07175148862550547, 'MSAVI': 88.8932662230853, 'MSK_CLDPRB': 0.37903469074266727, 'MSK_SNWPRB': 0, 'NBR': 0.05185448341563505, 'NDSI': 0.06561362368730257, 'NDVI': 0.08106633774978908, 'NDWI': 0.07175148862550547, 'OSAVI': 0.08106380496848258, 'QA10': 0, 'QA20': 0, 'QA60': 0, 'RECL': 1.7196662081455552, 'SAVI': 0.12158763564372037, 'SCL': 0, 'SIPI': 0.018029122741509883, 'TCI_B': 16.06143686764382, 'TCI_G': 13.214673633648946, 'TCI_R': 14.408042282685729, 'VARI': 0.07061210600847052, 'WVP': 40.57171763940917}",
//       "1": "{'AOT': 0.6209937763914867, 'ARVI': 0.0678875377269115, 'B1': 27.817186076413865, 'B11': 67.63613311563276, 'B12': 81.27297697506494, 'B2': 115.14967657411322, 'B3': 109.97349740880824, 'B4': 108.42346790798898, 'B5': 80.78141525771717, 'B6': 164.11998239104838, 'B7': 161.94250887729942, 'B8': 265.0781102559422, 'B8A': 181.74455993553983, 'B9': 153.533060791948, 'EVI': 0.313092604224242, 'EVI_1': 0.313092604224242, 'GCI': 0.6387247146538958, 'GNDVI': 0.05523442853518788, 'MSAVI': 52.84599444757114, 'MSK_CLDPRB': 0, 'MSK_SNWPRB': 0, 'NBR': 0.0506315442496517, 'NDSI': 0.04905571175561113, 'NDVI': 0.06071329932599226, 'NDWI': 0.05523442853518788, 'OSAVI': 0.06071113675837951, 'QA10': 0, 'QA20': 0, 'QA60': 0, 'RECL': 1.2621430327825782, 'SAVI': 0.09105981305498789, 'SCL': 0, 'SIPI': 0.01678845246972886, 'TCI_B': 11.904789269929836, 'TCI_G': 11.259106795048446, 'TCI_R': 11.211154315966235, 'VARI': 0.06792407717811681, 'WVP': 48.865580837104396}",
//   },
//   "Sum": {
//       "0": "{'AOT': 6115.2588235294115, 'ARVI': 15.469395769688138, 'B1': 7247.9607843137255, 'B11': 40509.521568627446, 'B12': 21776.62352941176, 'B2': 10836.701960784316, 'B3': 17124.458823529418, 'B4': 11363.741176470588, 'B5': 23930.72941176471, 'B6': 64671.16470588235, 'B7': 75745.13725490194, 'B8': 79073.43529411765, 'B8A': 78206.55686274507, 'B9': 77021.46274509802, 'EVI': 64.60782172239736, 'EVI_1': 64.60782172239736, 'GCI': 85.62152689221148, 'GNDVI': 14.841778111479465, 'MSAVI': -18257.340144139933, 'MSK_CLDPRB': 3.443137254901961, 'MSK_SNWPRB': 0, 'NBR': 13.113693916313833, 'NDSI': -9.396090326351894, 'NDVI': 17.273785840930987, 'NDWI': -14.841778111479465, 'OSAVI': 17.273071470693523, 'QA10': 0, 'QA20': 0, 'QA60': 0, 'RECL': 146.21361234736747, 'SAVI': 25.90733044931884, 'SCL': 92.54901960784315, 'SIPI': 23.28442683925536, 'TCI_B': 1103.7882352941176, 'TCI_G': 1752.2196078431368, 'TCI_R': 1162.7137254901957, 'VARI': 7.7416946839953145, 'WVP': 60726.02352941175}",
//       "1": "{'AOT': 5630.658823529411, 'ARVI': 14.82663048013788, 'B1': 9106.498039215685, 'B11': 43359.29019607843, 'B12': 23934.85098039216, 'B2': 10136.90980392157, 'B3': 16552.38431372549, 'B4': 12260.90980392157, 'B5': 25470.04705882353, 'B6': 63239.262745098036, 'B7': 74921.65098039218, 'B8': 74097.0862745098, 'B8A': 81099.12156862745, 'B9': 81641.16470588234, 'EVI': 50.48673070217713, 'EVI_1': 50.48673070217713, 'GCI': 81.90100268034847, 'GNDVI': 14.668283027777962, 'MSAVI': -17650.105820042558, 'MSK_CLDPRB': 0, 'MSK_SNWPRB': 0, 'NBR': 11.791576275746085, 'NDSI': -10.39597316442952, 'NDVI': 16.535141772985785, 'NDWI': -14.668283027777962, 'OSAVI': 16.53443114395489, 'QA10': 0, 'QA20': 0, 'QA60': 0, 'RECL': 121.42525233817265, 'SAVI': 24.79938189148927, 'SCL': 92.54901960784315, 'SIPI': 23.949924326091136, 'TCI_B': 1042.2470588235296, 'TCI_G': 1693.074509803921, 'TCI_R': 1259.0666666666666, 'VARI': 5.394825766957965, 'WVP': 62002.552941176466}",
//   },
//   "Variance": {
//       "0": "{'AOT': 0.3667296786367407, 'ARVI': 0.008322401730358456, 'B1': 2212.604914933828, 'B11': 31962.835538752053, 'B12': 13743.621928166274, 'B2': 25513.296786389394, 'B3': 16304.97542533084, 'B4': 19441.996219281675, 'B5': 11401.678638941406, 'B6': 104006.9754253302, 'B7': 142547.6483931943, 'B8': 192531.42911153124, 'B8A': 144474.92627599186, 'B9': 363916.0264650285, 'EVI': 2.513408752836047, 'EVI_1': 2.513408752836047, 'GCI': 0.6629062265203308, 'GNDVI': 0.0051482761199760415, 'MSAVI': 7902.0127798083195, 'MSK_CLDPRB': 0.14366729678638943, 'MSK_SNWPRB': 0, 'NBR': 0.00268888745030237, 'NDSI': 0.004305147613378953, 'NDVI': 0.006571751116162879, 'NDWI': 0.0051482761199760415, 'OSAVI': 0.006571340475968181, 'QA10': 0, 'QA20': 0, 'QA60': 0, 'RECL': 2.9572518674377117, 'SAVI': 0.0147835531414301, 'SCL': 0, 'SIPI': 0.00032504926682842887, 'TCI_B': 257.96975425330817, 'TCI_G': 174.62759924385665, 'TCI_R': 207.5916824196598, 'VARI': 0.004986069514951479, 'WVP': 1646.0642722119455}",
//       "1": "{'AOT': 0.3856332703169597, 'ARVI': 0.004608717778622832, 'B1': 773.7958412098334, 'B11': 4574.646502835595, 'B12': 6605.2967863894355, 'B2': 13259.448015122876, 'B3': 12094.170132325153, 'B4': 11755.648393194717, 'B5': 6525.63705103974, 'B6': 26935.368620038033, 'B7': 26225.3761814742, 'B8': 70266.40453686145, 'B8A': 33031.085066163025, 'B9': 23572.400756144005, 'EVI': 0.09802697881991786, 'EVI_1': 0.09802697881991786, 'GCI': 0.4079692611097006, 'GNDVI': 0.003050842095608777, 'MSAVI': 2792.6991291527193, 'MSK_CLDPRB': 0, 'MSK_SNWPRB': 0, 'NBR': 0.0025635532731044385, 'NDSI': 0.002406462855849604, 'NDVI': 0.0036861047150475324, 'NDWI': 0.003050842095608777, 'OSAVI': 0.0036858421264946597, 'QA10': 0, 'QA20': 0, 'QA60': 0, 'RECL': 1.5930050352016045, 'SAVI': 0.008291889553609344, 'SCL': 0, 'SIPI': 0.00028185213632834507, 'TCI_B': 141.72400756143654, 'TCI_G': 126.7674858223061, 'TCI_R': 125.68998109640835, 'VARI': 0.0046136802604987695, 'WVP': 2387.8449905475845}",
//   },
//   "index": {
//       "0": 0,
//       "1": 1,

const parser = (data) => {
  try {
    const parsed = JSON.parse(data.replace(/None/g, null).replace(/'/g, '"'));
    return parsed;
  } catch (err) {
    return data;
  }
};

const attributes = ['AOT', 'ARVI', 'EVI', 'GCI', 'GNDVI', 'MSAVI', 'NBR', 'NDVI', 'OSAVI', 'RECL', 'SAVI', 'SCL', 'SIPI', 'TCI_B', 'TCI_G', 'TCI_R', 'VARI', 'WVP']
const valuetypes = ['Variance', 'Mean', 'Median', 'Max', 'Min', 'StdDev', 'Sum','Mode']

export default async function handler(req, res) {
  const { farmid } = req.query

  let dates = []

  fetch(`http://192.168.100.17:5000/fetch_farm_monitored/?id=${farmid}`, {
    method: 'GET',
  }).then( res => res.json())

    .then( json => {
      dates = Object.values(json['Date'])
      return valuetypes.map(valuetype => (
        {
          
          [valuetype]: Object.values(json[valuetype])
            .map((value, index) => (
              parser(value)

            )),
          
        }
      ))
      // 

      })
    .then(json => {
      var obj = {}
      json.forEach((valuetype) => {

        Object.keys(valuetype).forEach((key) => {
          obj[key] = valuetype[key]
        })
      })
      return obj
    })
    .then(json => {
      var obj = {}
      obj['Date'] = dates
      attributes.forEach(attribute => {
          obj[attribute] = {
            'Variance': json['Variance'].map((value, index) => (
              value[attribute]
            )),
            'Mean': json['Mean'].map((value, index) => (
              value[attribute]
            )),
            'Median': json['Median'].map((value, index) => (
              value[attribute]
            )),
            'Max': json['Max'].map((value, index) => (
              value[attribute]
            )),
            'Min': json['Min'].map((value, index) => (
              value[attribute]
            )),
            'StdDev': json['StdDev'].map((value, index) => (
              value[attribute]
            )),
            'Sum': json['Sum'].map((value, index) => (
              value[attribute]
            )),

          }
        }
      )
      return obj
      }
    )
    .then(json => res.status(200).json(json))
    .catch(err => {
      res.send(err)
    })

}